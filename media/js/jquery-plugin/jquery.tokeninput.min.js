(function(a){a.fn.tokenInput=function(c,b){var d=a.extend({url:c,hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",searchDelay:300,minChars:1,tokenLimit:null,jsonContainer:null,method:"GET",contentType:"json",queryParam:"q",onResult:null},b);d.classes=a.extend({tokenList:"token-input-list",token:"token-input-token",tokenDelete:"token-input-delete-token",selectedToken:"token-input-selected-token",highlightedToken:"token-input-highlighted-token",dropdown:"token-input-dropdown",dropdownItem:"token-input-dropdown-item",dropdownItem2:"token-input-dropdown-item2",selectedDropdownItem:"token-input-selected-dropdown-item",inputToken:"token-input-input-token"},b.classes);return this.each(function(){var e=new a.TokenList(this,d)})};a.TokenList=function(s,D){var v={BEFORE:0,AFTER:1,END:2};var c={BACKSPACE:8,TAB:9,RETURN:13,ESC:27,LEFT:37,UP:38,RIGHT:39,DOWN:40,COMMA:188};var e=[];var j=0;var u=new a.TokenList.Cache();var q;var z=a('<input type="text">').css({outline:"none"}).focus(function(){if(D.tokenLimit==null||D.tokenLimit!=j){G()}}).blur(function(){t()}).keydown(function(J){var L;var I;switch(J.keyCode){case c.LEFT:case c.RIGHT:case c.UP:case c.DOWN:if(!a(this).val()){L=p.prev();I=p.next();if((L.length&&L.get(0)===k)||(I.length&&I.get(0)===k)){if(J.keyCode==c.LEFT||J.keyCode==c.UP){F(a(k),v.BEFORE)}else{F(a(k),v.AFTER)}}else{if((J.keyCode==c.LEFT||J.keyCode==c.UP)&&L.length){A(a(L.get(0)))}else{if((J.keyCode==c.RIGHT||J.keyCode==c.DOWN)&&I.length){A(a(I.get(0)))}}}}else{var K=null;if(J.keyCode==c.DOWN||J.keyCode==c.RIGHT){K=a(d).next()}else{K=a(d).prev()}if(K.length){l(K)}return false}break;case c.BACKSPACE:L=p.prev();if(!a(this).val().length){if(k){i(a(k))}else{if(L.length){A(a(L.get(0)))}}return false}else{if(a(this).val().length==1){t()}else{setTimeout(function(){C(false)},5)}}break;case c.TAB:case c.RETURN:case c.COMMA:if(d){b(a(d));return false}break;case c.ESC:t();return true;default:if(h(J.keyCode)){setTimeout(function(){C(false)},5)}break}});var H=a(s).hide().focus(function(){z.focus()}).blur(function(){z.blur()});var k=null;var d=null;var f=a("<ul />").addClass(D.classes.tokenList).insertAfter(H).click(function(J){var I=n(J,"li");if(I&&I.get(0)!=p.get(0)){m(I);return false}else{z.focus();if(k){F(a(k),v.END)}}}).mouseover(function(J){var I=n(J,"li");if(I&&k!==this){I.addClass(D.classes.highlightedToken)}}).mouseout(function(J){var I=n(J,"li");if(I&&k!==this){I.removeClass(D.classes.highlightedToken)}}).mousedown(function(J){var I=n(J,"li");if(I){return false}});var B=a("<div>").addClass(D.classes.dropdown).insertAfter(f).hide();var p=a("<li />").addClass(D.classes.inputToken).appendTo(f).append(z);E();function E(){li_data=D.prePopulate;if(li_data&&li_data.length){for(var I in li_data){var K=a("<li><p>"+li_data[I].name+"</p> </li>").addClass(D.classes.token).insertBefore(p);a("<span>x</span>").addClass(D.classes.tokenDelete).appendTo(K).click(function(){i(a(this).parent());return false});a.data(K.get(0),"tokeninput",{id:li_data[I].id,name:li_data[I].name});z.val("").focus();t();var J=li_data[I].id+",";H.val(H.val()+J)}}}function h(I){if((I>=48&&I<=90)||(I>=96&&I<=111)||(I>=186&&I<=192)||(I>=219&&I<=222)){return true}else{return false}}function n(J,L){var K=a(J.target);var I=null;if(K.is(L)){I=K}else{if(K.parent(L).length){I=K.parent(L+":first")}}return I}function x(K,I){var J=a("<li><p>"+I+"</p> </li>").addClass(D.classes.token).insertBefore(p);a("<span>x</span>").addClass(D.classes.tokenDelete).appendTo(J).click(function(){i(a(this).parent());return false});a.data(J.get(0),"tokeninput",{id:K,name:I});return J}function b(I){var L=a.data(I.get(0),"tokeninput");var K=x(L.id,L.name);z.val("").focus();t();var J=L.id+",";H.val(H.val()+J);j++;if(D.tokenLimit!=null&&D.tokenLimit>=j){z.hide();t()}}function A(I){I.addClass(D.classes.selectedToken);k=I.get(0);z.val("");t()}function F(J,I){J.removeClass(D.classes.selectedToken);k=null;if(I==v.BEFORE){p.insertBefore(J)}else{if(I==v.AFTER){p.insertAfter(J)}else{p.appendTo(f)}}z.focus()}function m(I){if(k==I.get(0)){F(I,v.END)}else{if(k){F(a(k),v.END)}A(I)}}function i(J){var K=a.data(J.get(0),"tokeninput");J.remove();k=null;z.focus();var L=H.val();var M=L.indexOf(K.id+",");var I=L.indexOf(",",M)+1;if(I>=L.length){H.val(L.slice(0,M))}else{H.val(L.slice(0,M)+L.slice(I,L.length))}j--;if(D.tokenLimit!=null){z.show().val("").focus()}}function t(){B.hide().empty();d=null}function g(){B.html("<p>"+D.searchingText+"</p>").show()}function G(){B.html("<p>"+D.hintText+"</p>").show()}function r(J,I){return J.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+I+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>")}function y(L,J){if(J.length){B.empty();var K=a("<ul>").appendTo(B).mouseover(function(N){l(n(N,"li"))}).click(function(N){b(n(N,"li"))}).mousedown(function(N){return false}).hide();for(var I in J){if(J.hasOwnProperty(I)){var M=a("<li>"+r(J[I].name,L)+"</li>").appendTo(K);if(I%2){M.addClass(D.classes.dropdownItem)}else{M.addClass(D.classes.dropdownItem2)}if(I==0){l(M)}a.data(M.get(0),"tokeninput",{id:J[I].id,name:J[I].name})}}B.show();K.slideDown("fast")}else{B.html("<p>"+D.noResultsText+"</p>").show()}}function l(I){if(I){if(d){o(a(d))}I.addClass(D.classes.selectedDropdownItem);d=I.get(0)}}function o(I){I.removeClass(D.classes.selectedDropdownItem);d=null}function C(I){var J=z.val().toLowerCase();if(J&&J.length){if(k){F(a(k),v.AFTER)}if(J.length>=D.minChars){g();if(I){w(J)}else{clearTimeout(q);q=setTimeout(function(){w(J)},D.searchDelay)}}else{t()}}}function w(J){var I=u.get(J);if(I){y(J,I)}else{var L=D.url.indexOf("?")<0?"?":"&";var K=function(M){if(a.isFunction(D.onResult)){M=D.onResult.call(this,M)}u.add(J,D.jsonContainer?M[D.jsonContainer]:M);y(J,D.jsonContainer?M[D.jsonContainer]:M)};if(D.method=="POST"){a.post(D.url,{q:J},K,D.contentType)}else{a.get(D.url+L+D.queryParam+"="+J,{},K,D.contentType)}}}};a.TokenList.Cache=function(c){var e=a.extend({max_size:50},c);var f={};var d=0;var b=function(){f={};d=0};this.add=function(h,g){if(d>e.max_size){b()}if(!f[h]){d++}f[h]=g};this.get=function(g){return f[g]}}})(jQuery);